name: Create merge PR to main
run-name: "Raise merge PR to main from dev ${{ github.sha }}"

on:
  # Manual + auto on pushes to dev
  workflow_dispatch: {}
  push:
    branches: [ dev ]

# Prevent overlapping runs from racing each other
concurrency:
  group: dev-main-pr
  cancel-in-progress: true

jobs:
  create_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch branches
        shell: bash
        run: |
          git fetch --no-tags origin main
          git fetch --no-tags origin dev

      - name: Extract BOS tickets from dev not in main
        id: extract
        shell: bash
        run: |
          set -euo pipefail
          COMMITS=$(git log origin/main..origin/dev --pretty=format:"%s")
          TICKETS=$(
            echo "$COMMITS" \
            | (grep -oiE 'bos[-_][0-9]+' || true) \
            | tr '[:lower:]' '[:upper:]' \
            | sed 's/_/-/g' \
            | sort -u \
            | paste -sd ',' -
          )
          {
            echo 'tickets<<EOF'
            echo "$TICKETS"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build PR title/body (cap at 256 chars; prepare comment if needed)
        id: compose
        shell: bash
        run: |
          set -euo pipefail
          BASE="Merge dev to main"
          TICKETS="${{ steps.extract.outputs.tickets }}"
          if [ -n "$TICKETS" ]; then
            TITLE="$BASE ($TICKETS)"
            BODY=$'Triggered by a merge in dev.\nIncludes tickets: '"$TICKETS"
          else
            TITLE="$BASE"
            BODY="Triggered by a merge in dev. No BOS tickets detected."
          fi

          # GitHub title limit: 256 chars
          TRUNCATED="false"
          COMMENT_BODY=""
          if [ ${#TITLE} -gt 256 ]; then
            TRUNCATED="true"
            TITLE="${TITLE:0:253}..."
            if [ -n "$TICKETS" ]; then
              COMMENT_BODY=$'⚠️ Full ticket list exceeded title limit.\n\n**All tickets:**\n'"$TICKETS"
            fi
          fi

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "truncated=$TRUNCATED" >> "$GITHUB_OUTPUT"
          {
            echo 'body<<EOF'
            echo "$BODY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          {
            echo 'comment_body<<EOF'
            echo "$COMMENT_BODY"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Find existing dev→main PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NUM=$(gh pr list --base main --head dev --json number --jq '.[0].number // empty')
          echo "number=$NUM" >> "$GITHUB_OUTPUT"

      - name: Create PR if none exists
        if: steps.pr.outputs.number == ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head dev \
            --title "${{ steps.compose.outputs.title }}" \
            --body  "${{ steps.compose.outputs.body }}"

          if [ "${{ steps.compose.outputs.truncated }}" = "true" ] && [ -n "${{ steps.compose.outputs.comment_body }}" ]; then
            PR_NUMBER=$(gh pr list --base main --head dev --json number --jq '.[0].number')
            gh pr comment "$PR_NUMBER" --body "${{ steps.compose.outputs.comment_body }}"
          fi

      - name: Update PR title (and post comment if truncated)
        if: steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR="${{ steps.pr.outputs.number }}"
          CUR=$(gh pr view "$PR" --json title --jq '.title')
          NEW="${{ steps.compose.outputs.title }}"
          if [ "$CUR" != "$NEW" ]; then
            gh pr edit "$PR" --title "$NEW"
          fi

          if [ "${{ steps.compose.outputs.truncated }}" = "true" ] && [ -n "${{ steps.compose.outputs.comment_body }}" ]; then
            gh pr comment "$PR" --body "${{ steps.compose.outputs.comment_body }}"
          fi
